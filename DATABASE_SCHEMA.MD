# Database Schema for LLM Society Simulation

This document outlines the proposed database schemas for persisting dynamic and large-scale data generated by the LLM Society Simulation. The primary goal is to support long-running autonomous simulations, data analysis, and potentially agent memory retrieval.

We will likely use a relational database like PostgreSQL due to its robustness, support for JSONB/arrays, and full-text search capabilities. Specific data types below are PostgreSQL-like but can be adapted.

## Core Tables

### 1. `simulation_runs` (Optional, but Recommended)

Tracks individual simulation executions.

| Column Name       | Data Type        | Constraints                   | Description                                      |
|-------------------|------------------|-------------------------------|--------------------------------------------------|
| `run_id`          | UUID             | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique identifier for the simulation run.        |
| `config_snapshot` | JSONB            |                               | A snapshot of the simulation config used for this run. |
| `start_time`      | TIMESTAMPTZ      | NOT NULL, DEFAULT NOW()       | Real-world timestamp when the run started.        |
| `end_time`        | TIMESTAMPTZ      |                               | Real-world timestamp when the run ended/was stopped. |
| `status`          | VARCHAR(50)      |                               | e.g., 'running', 'completed', 'failed', 'stopped'   |
| `notes`           | TEXT             |                               | Any manual notes about this specific run.        |

### 2. `agents` (Optional - if not relying solely on agent_id in other tables)

Stores static or slowly changing information about each agent if not fully captured in save files or if needed for cross-simulation analysis.

| Column Name     | Data Type     | Constraints              | Description                               |
|-----------------|---------------|--------------------------|-------------------------------------------|
| `agent_id_str`  | VARCHAR(255)  | PRIMARY KEY              | The unique string ID of the agent (e.g., "agent_0"). |
| `persona`       | TEXT          |                          | Agent's initial or core persona.           |
| `initial_agent_type` | VARCHAR(50) |                          | Agent's type at creation (e.g., from AgentType enum). |
| `creation_run_id`| UUID         | FOREIGN KEY (simulation_runs) | ID of the simulation run where agent was created. |
| `creation_step` | INTEGER       |                          | Simulation step at which the agent was created. |

### 3. `agent_memories`

Stores individual memories for each agent.

| Column Name        | Data Type     | Constraints                        | Description                                      |
|--------------------|---------------|------------------------------------|--------------------------------------------------|
| `memory_id`        | UUID          | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique identifier for the memory entry.          |
| `agent_id_str`     | VARCHAR(255)  | NOT NULL, (FK to `agents` if table exists) | The agent this memory belongs to.                |
| `simulation_run_id`| UUID          | (FK to `simulation_runs`)          | ID of the simulation run for this memory.        |
| `step_timestamp`   | INTEGER       | NOT NULL                           | Simulation step when the memory was recorded.    |
| `real_timestamp`   | TIMESTAMPTZ   | DEFAULT NOW()                      | Real-world timestamp of memory recording.        |
| `content`          | TEXT          | NOT NULL                           | The textual content of the memory.               |
| `importance`       | REAL          |                                    | Importance score of the memory (e.g., 0.0-1.0).  |
| `tags`             | TEXT[]        |                                    | Array of tags associated with the memory.        |
| `related_agent_id` | VARCHAR(255)  |                                    | Optional ID of another agent related to this memory. |

*Indexes: `(agent_id_str, step_timestamp)`, `(agent_id_str, importance)`, `tags` (GIN index for array search)*

### 4. `market_transactions`

Records every completed trade in any market.

| Column Name         | Data Type     | Constraints                        | Description                                       |
|---------------------|---------------|------------------------------------|---------------------------------------------------|
| `transaction_id_pk` | BIGSERIAL     | PRIMARY KEY                        | Auto-incrementing primary key for the DB record.  |
| `transaction_sim_id`| VARCHAR(255)  | NOT NULL                           | The simulation-generated transaction ID.          |
| `simulation_run_id` | UUID          | (FK to `simulation_runs`)          | ID of the simulation run.                         |
| `step_timestamp`    | INTEGER       | NOT NULL                           | Simulation step of the transaction.               |
| `real_timestamp`    | TIMESTAMPTZ   | DEFAULT NOW()                      | Real-world timestamp of the transaction.          |
| `market_id`         | VARCHAR(255)  | NOT NULL                           | Identifier for the market (e.g., "market_food").  |
| `resource_type`     | VARCHAR(50)   | NOT NULL                           | The traded resource (e.g., "food", "tools").    |
| `buyer_agent_id`    | VARCHAR(255)  | NOT NULL                           | ID of the buying agent.                           |
| `seller_agent_id`   | VARCHAR(255)  | NOT NULL                           | ID of the selling agent.                          |
| `quantity`          | REAL          | NOT NULL                           | Quantity of the resource traded.                  |
| `price_per_unit`    | REAL          | NOT NULL                           | Price per unit of the resource.                   |
| `total_cost`        | REAL          | NOT NULL                           | Total cost of the transaction.                    |
| `buy_order_id`      | VARCHAR(255)  |                                    | ID of the corresponding buy order.                |
| `sell_order_id`     | VARCHAR(255)  |                                    | ID of the corresponding sell order.               |

*Indexes: `(resource_type, step_timestamp)`, `(buyer_agent_id)`, `(seller_agent_id)`*

### 5. `banking_transactions`

Records all banking transactions (deposits, withdrawals, transfers, loan payments, fees, interest).

| Column Name         | Data Type     | Constraints                        | Description                                      |
|---------------------|---------------|------------------------------------|--------------------------------------------------|
| `transaction_id_pk` | BIGSERIAL     | PRIMARY KEY                        | Auto-incrementing primary key.                   |
| `transaction_sim_id`| VARCHAR(255)  | NOT NULL, UNIQUE                   | Simulation-generated transaction ID.             |
| `simulation_run_id` | UUID          | (FK to `simulation_runs`)          | ID of the simulation run.                        |
| `step_timestamp`    | INTEGER       | NOT NULL                           | Simulation step of the transaction.              |
| `real_timestamp`    | TIMESTAMPTZ   | DEFAULT NOW()                      | Real-world timestamp.                            |
| `account_id`        | VARCHAR(255)  | NOT NULL                           | Bank account ID involved.                        |
| `agent_id_str`      | VARCHAR(255)  | NOT NULL                           | Agent ID owning the account.                     |
| `transaction_type`  | VARCHAR(50)   | NOT NULL                           | Type of transaction (e.g., "deposit", "withdrawal"). |
| `amount`            | REAL          | NOT NULL                           | Amount of the transaction (can be negative for transfers out). |
| `balance_after`     | REAL          | NOT NULL                           | Account balance after this transaction.          |
| `description`       | TEXT          |                                    | Description of the transaction.                  |
| `counterparty_id`   | VARCHAR(255)  |                                    | Optional counterparty account or agent ID.       |
| `reference_id`      | VARCHAR(255)  |                                    | Optional reference to another entity (e.g., loan_id for payment). |

*Indexes: `(account_id, step_timestamp)`, `(agent_id_str)`, `(transaction_type)`*

### 6. `simulation_events` (Generic Event Log - Optional)

A table to log various significant events occurring in the simulation (e.g., agent births/deaths (if not part of agent state), marriages, major discoveries, disasters if implemented).

| Column Name         | Data Type     | Constraints                        | Description                                      |
|---------------------|---------------|------------------------------------|--------------------------------------------------|
| `event_id`          | BIGSERIAL     | PRIMARY KEY                        | Unique identifier for the event.                 |
| `simulation_run_id` | UUID          | (FK to `simulation_runs`)          | ID of the simulation run.                        |
| `step_timestamp`    | INTEGER       | NOT NULL                           | Simulation step of the event.                    |
| `real_timestamp`    | TIMESTAMPTZ   | DEFAULT NOW()                      | Real-world timestamp.                            |
| `event_type`        | VARCHAR(100)  | NOT NULL                           | Type of event (e.g., "AGENT_MARRIAGE", "ASSET_CREATED"). |
| `agent_id_primary`  | VARCHAR(255)  |                                    | Primary agent involved, if any.                  |
| `agent_id_secondary`| VARCHAR(255)  |                                    | Secondary agent involved, if any.                |
| `details`           | JSONB         |                                    | JSON object containing event-specific details.   |
| `description`       | TEXT          |                                    | Human-readable description of the event.         |

*Indexes: `(event_type, step_timestamp)`, `(agent_id_primary)`*

## Considerations for Schema Design:

*   **Simulation Runs**: If you plan to run multiple simulations and compare/analyze data across them, a `simulation_runs` table is highly beneficial to partition data.
*   **Agent Table**: A dedicated `agents` table is useful if you need to query agents across runs or store relatively static agent info. If agent state is always loaded from save files, this might be less critical, and `agent_id_str` in other tables can just be the string identifier.
*   **Normalization vs. Denormalization**: Schemas above are relatively normalized. For specific analytics queries, denormalized views or tables might be created.
*   **Data Types**: Chosen for PostgreSQL. `REAL` for floating-point, `INTEGER` for steps, `TEXT` for strings, `UUID` for unique IDs, `TIMESTAMPTZ` for real-world time, `JSONB` for flexible structured data, `TEXT[]` for arrays of tags.
*   **Indexes**: Suggested basic indexes for common query patterns. More specific indexes will depend on actual analytics and retrieval needs.

This schema design is a starting point and can be expanded or refined as the simulation's data persistence requirements become clearer.
